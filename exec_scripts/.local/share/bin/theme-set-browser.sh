#!/bin/bash

# Set browser theme based on current theme

CURRENT_THEME_LINK="$HOME/.config/current-theme"
BRAVE_PREFS="$HOME/.config/BraveSoftware/Brave-Browser/Default/Preferences"
BRAVE_POLICY="/etc/brave/policies/managed/color.json"

# Get current theme
if [[ ! -L "$CURRENT_THEME_LINK" ]]; then
    echo "No theme currently set"
    exit 1
fi

THEME_PATH=$(readlink "$CURRENT_THEME_LINK")
CHROMIUM_THEME_FILE="$THEME_PATH/chromium.theme"

if [[ ! -f "$CHROMIUM_THEME_FILE" ]]; then
    echo "No browser theme config found for current theme"
    exit 1
fi

# Read RGB color values from chromium.theme (format: R,G,B)
COLOR=$(cat "$CHROMIUM_THEME_FILE" | tr -d ' ')

if [[ -z "$COLOR" ]]; then
    echo "Invalid browser theme configuration"
    exit 1
fi

# Parse RGB values
IFS=',' read -r R G B <<<"$COLOR"

# Convert RGB to hex for policy file
HEX_COLOR=$(printf "#%02x%02x%02x" "$R" "$G" "$B")

# Update Brave policy file (requires sudo)
if [[ -f "$BRAVE_POLICY" ]] && [[ -w "$BRAVE_POLICY" ]]; then
    echo "{\"BrowserThemeColor\": \"$HEX_COLOR\"}" >"$BRAVE_POLICY"
    echo "Updated Brave policy: $HEX_COLOR"
elif [[ -d "$(dirname "$BRAVE_POLICY")" ]]; then
    # Try with sudo if file exists but not writable
    if sudo -n true 2>/dev/null; then
        echo "{\"BrowserThemeColor\": \"$HEX_COLOR\"}" | sudo tee "$BRAVE_POLICY" >/dev/null
        echo "Updated Brave policy (with sudo): $HEX_COLOR"
    else
        echo "Note: Run this to update Brave theme policy:"
        echo "  sudo bash -c 'echo \"{\\\"BrowserThemeColor\\\": \\\"$HEX_COLOR\\\"}\" > $BRAVE_POLICY'"
    fi
fi

# Apply to Brave browser if preferences file exists
if [[ -f "$BRAVE_PREFS" ]]; then
    # Check if Brave is running
    brave_running=0
    if pgrep -x brave >/dev/null; then
        brave_running=1
    fi

    # Backup preferences
    cp "$BRAVE_PREFS" "${BRAVE_PREFS}.backup-$(date +%Y%m%d-%H%M%S)"

    # Update theme colors using jq
    if command -v jq >/dev/null 2>&1; then
        tmp_file=$(mktemp)
        jq --argjson r "$R" --argjson g "$G" --argjson b "$B" '
            .autogenerated_theme_colors = {
                "color_frame": [$r, $g, $b],
                "color_toolbar": [$r, $g, $b],
                "color_tab_background_inactive_frame_active": [$r, $g, $b],
                "color_ntp_background": [$r, $g, $b]
            } |
            .extensions.theme.use_system = false
        ' "$BRAVE_PREFS" >"$tmp_file" && mv "$tmp_file" "$BRAVE_PREFS"

        if [[ $brave_running -eq 1 ]]; then
            echo "Browser theme color set to: RGB($R, $G, $B)"
            echo "Note: Restart Brave to see the changes"
        else
            echo "Browser theme color applied: RGB($R, $G, $B)"
        fi
    else
        echo "Error: jq is required to update browser theme"
        exit 1
    fi
else
    echo "Brave preferences file not found at: $BRAVE_PREFS"
    exit 1
fi
